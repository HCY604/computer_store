package controller;

import model.Employee;
import service.FundService;
import service.impl.FundServiceImpl;
import util.UiKit;

import javax.swing.*;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;

public class AdminPanel extends JFrame {
    private static final long serialVersionUID = 1L;

    private final Employee adminEmp;
    private final JFrame employeeBackFrame;
    private JLabel lblBalance;
    private final FundService fundSvc = new FundServiceImpl();
    private Timer autoRefresh;

    public AdminPanel(Employee adminEmp, JFrame employeeBackFrame) {
        this.adminEmp = adminEmp;
        this.employeeBackFrame = employeeBackFrame;
        buildUi();
        autoRefresh = new Timer(3000, e -> refreshBalance());
        autoRefresh.start();
        addWindowListener(new WindowAdapter() {
            @Override public void windowClosed(WindowEvent e) { if (autoRefresh!=null) autoRefresh.stop(); }
        });
    }

    private void buildUi() {
        setSize(900, 360);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "管理員面板 - " + adminEmp.getName() + "（" + adminEmp.getEmpCode() + "）");
        UiKit.createBackButton(this, e -> { if (employeeBackFrame!=null) employeeBackFrame.setVisible(true); if (autoRefresh!=null) autoRefresh.stop(); dispose(); });

        lblBalance = new JLabel("公司資金餘額：$" + fundSvc.getBalance());
        lblBalance.setBounds(110, 10, 300, 24); add(lblBalance);

        JButton btnProcure   = new JButton("採購進貨（安全水位）"); btnProcure.setBounds(20, 50, 170, 28); add(btnProcure);
        JButton btnHire      = new JButton("新增員工");            btnHire.setBounds(200, 50, 120, 28); add(btnHire);
        JButton btnFire      = new JButton("開除員工");            btnFire.setBounds(330, 50, 120, 28); add(btnFire);
        JButton btnPayroll   = new JButton("薪資結清");            btnPayroll.setBounds(460, 50, 120, 28); add(btnPayroll);
        JButton btnReport    = new JButton("報表與分析");          btnReport.setBounds(590, 50, 120, 28); add(btnReport);
        JButton btnLogoutAll = new JButton("登出到主選單");         btnLogoutAll.setBounds(720, 50, 150, 28); add(btnLogoutAll);

        btnProcure.addActionListener(e -> new ProcurementUi(this::refreshBalance).setVisible(true));
        btnHire.addActionListener(e -> new HireEmployeeUi().setVisible(true));
        btnFire.addActionListener(e -> new FireEmployeeUi().setVisible(true));
        btnPayroll.addActionListener(e -> new PayrollSettlementUi(this::refreshBalance).setVisible(true));
        btnReport.addActionListener(e -> new AdminReportDashboard(this).setVisible(true));
        btnLogoutAll.addActionListener(e -> { new RoleSelector().setVisible(true); if (autoRefresh!=null) autoRefresh.stop(); dispose(); });
    }

    private void refreshBalance(){ lblBalance.setText("公司資金餘額：$" + fundSvc.getBalance()); }
}
