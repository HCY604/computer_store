package controller;

import service.ReportService;
import service.impl.ReportServiceImpl;
import util.UiKit;
import util.ChartKit;
import vo.DailyFinanceVo;

import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.data.category.DefaultCategoryDataset;
import org.jfree.data.general.DefaultPieDataset;

import javax.swing.*;
import java.awt.*;
import java.awt.print.PrinterJob;
import java.awt.print.Printable;
import java.awt.print.PageFormat;
import java.awt.print.PrinterException;
import java.io.FileOutputStream;
import java.util.List;

import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

public class AdminReportDashboard extends JFrame {
    private static final long serialVersionUID = 1L;

    private final JFrame backFrame;
    private final ReportService reportSvc = new ReportServiceImpl();

    private JComboBox<String> cboRange, cboChartType, cboCostMethod;
    private JLabel lblSumSales, lblSumProcure, lblSumPayroll, lblSumNet;
    private JPanel chartHolder;
    private ChartPanel chartPanel;

    private Timer autoRefresh;

    public AdminReportDashboard(JFrame backFrame) {
        this.backFrame = backFrame;
        buildUi();
        reloadAndDraw();
        // 每 5 秒自動刷新一次（即時觀測）
        autoRefresh = new Timer(5000, e -> reloadAndDraw());
        autoRefresh.start();
    }

    private void buildUi() {
        setSize(1150, 820);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "報表與分析");
        UiKit.createBackButton(this, e -> { if (backFrame!=null) backFrame.setVisible(true); autoRefresh.stop(); dispose(); });

        int y = 10;
        JLabel lRange = new JLabel("區間："); lRange.setBounds(110, y, 50, 26); add(lRange);
        cboRange = new JComboBox<>(new String[]{"近 7 天", "近 30 天", "近 90 天"});
        cboRange.setBounds(160, y, 110, 28); add(cboRange);

        JLabel lType = new JLabel("圖表："); lType.setBounds(280, y, 50, 26); add(lType);
        cboChartType = new JComboBox<>(new String[]{"折線圖（日別趨勢）", "長條圖（彙總對比）", "圓餅圖（構成比例）"});
        cboChartType.setBounds(330, y, 190, 28); add(cboChartType);

        JLabel lCost = new JLabel("成本法："); lCost.setBounds(530, y, 60, 26); add(lCost);
        cboCostMethod = new JComboBox<>(new String[]{"採購成本法（本期採購）", "銷售成本法（70%）"});
        cboCostMethod.setBounds(590, y, 180, 28); add(cboCostMethod);

        JButton btnRefresh = new JButton("重新整理"); btnRefresh.setBounds(780, y, 110, 28); add(btnRefresh);
        JButton btnPrint   = new JButton("列印圖表"); btnPrint.setBounds(900, y, 110, 28); add(btnPrint);
        JButton btnExport  = new JButton("匯出 Excel"); btnExport.setBounds(1020, y, 110, 28); add(btnExport);

        y += 34;
        lblSumSales   = new JLabel("總營收：$0");          lblSumSales.setBounds(20,  y, 260, 24); add(lblSumSales);
        lblSumProcure = new JLabel("成本：$0");            lblSumProcure.setBounds(280, y, 260, 24); add(lblSumProcure);
        lblSumPayroll = new JLabel("人事成本：$0");        lblSumPayroll.setBounds(540, y, 260, 24); add(lblSumPayroll);
        lblSumNet     = new JLabel("淨利潤(損益)：$0");     lblSumNet.setBounds(800, y, 260, 24); add(lblSumNet);

        chartHolder = new JPanel(new BorderLayout());
        chartHolder.setBorder(BorderFactory.createTitledBorder("每日營收 / 成本 / 人事 / 淨利"));
        chartHolder.setBounds(20, 80, 1110, 700);
        add(chartHolder);

        btnRefresh.addActionListener(e -> reloadAndDraw());
        btnPrint.addActionListener(e -> printChart());
        btnExport.addActionListener(e -> exportExcel());
        cboRange.addActionListener(e -> reloadAndDraw());
        cboChartType.addActionListener(e -> reloadAndDraw());
        cboCostMethod.addActionListener(e -> reloadAndDraw());
    }

    private int getRangeDays() {
        String s = (String) cboRange.getSelectedItem();
        if (s == null || s.contains("30")) return 30;
        if (s.contains("7")) return 7;
        if (s.contains("90")) return 90;
        return 30;
    }

    private boolean useCOGS() {
        String s = (String) cboCostMethod.getSelectedItem();
        return s != null && s.startsWith("銷售成本法");
    }

    private void reloadAndDraw() {
        List<DailyFinanceVo> data = reportSvc.listDailyFinance(getRangeDays());
        boolean cogs = useCOGS();

        int sumSales=0, sumCost=0, sumPayroll=0, sumNet=0;
        for (DailyFinanceVo v : data) {
            sumSales   += v.getSalesAmount();
            sumCost    += cogs ? v.getCogsBySales() : v.getProcureCost();
            sumPayroll += v.getPayrollCost();
        }
        sumNet = sumSales - sumCost - sumPayroll;

        lblSumSales.setText("總營收：$" + sumSales);
        lblSumProcure.setText("成本（"+(cogs?"銷售成本70%":"採購成本")+"）：$" + sumCost);
        lblSumPayroll.setText("人事成本：$" + sumPayroll);
        lblSumNet.setText("淨利潤(損益)：$" + sumNet);

        String want = (String) cboChartType.getSelectedItem();
        JFreeChart chart;

        if (want == null || want.startsWith("折線圖")) {
            DefaultCategoryDataset ds = new DefaultCategoryDataset();
            for (DailyFinanceVo v : data) {
                ds.addValue(v.getSalesAmount(), "營收", v.getBizDate());
                ds.addValue(cogs ? v.getCogsBySales() : v.getProcureCost(), "成本", v.getBizDate());
                ds.addValue(v.getPayrollCost(), "人事成本", v.getBizDate());
                ds.addValue(v.getSalesAmount() - (cogs ? v.getCogsBySales() : v.getProcureCost()) - v.getPayrollCost(),
                        "淨利潤", v.getBizDate());
            }
            chart = ChartFactory.createLineChart("每日營收/成本/人事/淨利（日別）", "日期", "金額", ds);
        } else if (want.startsWith("圓餅圖")) {
            DefaultPieDataset<String> pds = new DefaultPieDataset<>();
            int netForPie = Math.max(0, sumNet);
            if (sumCost==0 && sumPayroll==0 && netForPie==0) pds.setValue("無資料", 1);
            else {
                pds.setValue("成本", sumCost);
                pds.setValue("人事成本", sumPayroll);
                pds.setValue("淨利潤", netForPie);
            }
            chart = ChartFactory.createPieChart("期間構成比例（成本/人事/淨利）", pds, true, true, false);
        } else {
            DefaultCategoryDataset ds = new DefaultCategoryDataset();
            ds.addValue(sumSales,   "金額", "總營收");
            ds.addValue(sumCost,    "金額", "成本");
            ds.addValue(sumPayroll, "金額", "人事成本");
            ds.addValue(sumNet,     "金額", "淨利潤");
            chart = ChartFactory.createBarChart("期間彙總對比", "項目", "金額", ds);
        }

        ChartKit.applyTheme(chart);
        chartPanel = new ChartPanel(chart);
        chartHolder.removeAll();
        chartHolder.add(chartPanel, BorderLayout.CENTER);
        chartHolder.revalidate();
        chartHolder.repaint();
    }

    private void printChart() {
        try {
            if (chartPanel == null) return;
            PrinterJob job = PrinterJob.getPrinterJob();
            job.setJobName("FinanceChart");
            job.setPrintable(new Printable() {
                @Override
                public int print(Graphics g, PageFormat pf, int pageIndex) throws PrinterException {
                    if (pageIndex > 0) return NO_SUCH_PAGE;
                    Graphics2D g2 = (Graphics2D) g;
                    g2.translate(pf.getImageableX(), pf.getImageableY());
                    chartPanel.printAll(g2);
                    return PAGE_EXISTS;
                }
            });
            if (job.printDialog()) job.print();
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "列印失敗：" + ex.getMessage());
        }
    }

    private void exportExcel() {
        List<DailyFinanceVo> data = reportSvc.listDailyFinance(365);
        boolean cogs = useCOGS();

        JFileChooser fc = new JFileChooser();
        fc.setDialogTitle("儲存 Excel");
        fc.setSelectedFile(new java.io.File("FinanceReport.xlsx"));
        if (fc.showSaveDialog(this) != JFileChooser.APPROVE_OPTION) return;

        try (Workbook wb = new XSSFWorkbook()) {
            Sheet sh = wb.createSheet("Daily");
            int r = 0;
            Row head = sh.createRow(r++);
            head.createCell(0).setCellValue("日期");
            head.createCell(1).setCellValue("營收");
            head.createCell(2).setCellValue(cogs ? "成本(銷售70%)" : "成本(採購)");
            head.createCell(3).setCellValue("人事成本");
            head.createCell(4).setCellValue("淨利潤");

            int sumSales=0, sumCost=0, sumPayroll=0, sumNet=0;
            for (DailyFinanceVo v : data) {
                int cost = cogs ? v.getCogsBySales() : v.getProcureCost();
                int net  = v.getSalesAmount() - cost - v.getPayrollCost();

                Row row = sh.createRow(r++);
                row.createCell(0).setCellValue(v.getBizDate());
                row.createCell(1).setCellValue(v.getSalesAmount());
                row.createCell(2).setCellValue(cost);
                row.createCell(3).setCellValue(v.getPayrollCost());
                row.createCell(4).setCellValue(net);

                sumSales   += v.getSalesAmount();
                sumCost    += cost;
                sumPayroll += v.getPayrollCost();
                sumNet     += net;
            }
            for (int i=0;i<=4;i++) sh.autoSizeColumn(i);

            Sheet sum = wb.createSheet("Summary");
            Row h2 = sum.createRow(0);
            h2.createCell(0).setCellValue("總營收");
            h2.createCell(1).setCellValue("成本");
            h2.createCell(2).setCellValue("人事成本");
            h2.createCell(3).setCellValue("淨利潤");
            Row d2 = sum.createRow(1);
            d2.createCell(0).setCellValue(sumSales);
            d2.createCell(1).setCellValue(sumCost);
            d2.createCell(2).setCellValue(sumPayroll);
            d2.createCell(3).setCellValue(sumNet);
            for (int i=0;i<=3;i++) sum.autoSizeColumn(i);

            try (FileOutputStream out = new FileOutputStream(fc.getSelectedFile())) {
                wb.write(out);
            }
            JOptionPane.showMessageDialog(this, "匯出成功：" + fc.getSelectedFile().getAbsolutePath());
        } catch (Exception ex) {
            JOptionPane.showMessageDialog(this, "匯出失敗：" + ex.getMessage());
        }
    }
}
