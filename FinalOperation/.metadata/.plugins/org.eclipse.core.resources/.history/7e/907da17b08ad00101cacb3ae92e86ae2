package controller;

import model.Goods;
import model.Member;
import service.FundService;
import service.GoodsService;
import service.ProductService;
import service.impl.FundServiceImpl;
import service.impl.GoodsServiceImpl;
import service.impl.ProductServiceImpl;
import util.ChangeTool;
import util.Tool;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.print.PrinterException;
import java.text.MessageFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class CheckoutReview extends JFrame {
    private static final long serialVersionUID = 1L;

    private final Order order;
    private final Runnable onCompleted;
    private JTable table;
    private JLabel lblTotal;

    public CheckoutReview(Order order, Runnable onCompleted) {
        this.order = order;
        this.onCompleted = onCompleted;

        setSize(740, 520);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "結帳確認");
        UiKit.createBackButton(this, e -> { dispose(); });

        String[] cols = {"類別","產品","單價","數量","小計"};
        DefaultTableModel m = new DefaultTableModel(cols,0){ public boolean isCellEditable(int r,int c){ return false; }};
        table = new JTable(m);
        JScrollPane sp = new JScrollPane(table); sp.setBounds(20,50,680,360); add(sp);

        JButton btnDel = new JButton("刪除選取"); btnDel.setBounds(20,420,110,28); add(btnDel);
        lblTotal = new JLabel("應付總額：$"+order.getTotalAmount()); lblTotal.setBounds(150,420,220,28); add(lblTotal);
        JButton btnConfirm = new JButton("確認購買並列印"); btnConfirm.setBounds(520,420,180,28); add(btnConfirm);

        btnDel.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row<0){ JOptionPane.showMessageDialog(this,"先選一列"); return; }
            order.removeItemAt(row);
            m.removeRow(row);
            refreshTotal();
        });
        btnConfirm.addActionListener(e -> doPurchaseAndPrint());

        reloadTable(m);
    }

    private void reloadTable(DefaultTableModel m){
        m.setRowCount(0);
        for (Order.Item it : order.getItems()) {
            m.addRow(new Object[]{it.getCategoryName(), it.getProductName(), it.getUnitPrice(), it.getQuantity(), it.getLineTotal()});
        }
        refreshTotal();
    }

    private void refreshTotal(){ lblTotal.setText("應付總額：$"+order.getTotalAmount()); }

    private void doPurchaseAndPrint() {
        int total = order.getTotalAmount();
        if (total <= 0) { JOptionPane.showMessageDialog(this, "購物車已空"); return; }

        String s = JOptionPane.showInputDialog(this, "請輸入付款金額（整數）", String.valueOf(total));
        if (s == null) return;
        int cash;
        try { cash = Integer.parseInt(s.trim()); } catch (Exception ex) { JOptionPane.showMessageDialog(this, "金額格式不正確"); return; }
        if (cash < total) { JOptionPane.showMessageDialog(this, "付款金額不足（應付 $" + total + "）"); return; }
        int change = cash - total;

        Integer memberId = null;
        try { Member m = Tool.loadMember(); if (m != null) memberId = m.getId(); } catch (Exception ignore){}

        GoodsService goodsSvc = new GoodsServiceImpl();
        ProductService prodSvc = new ProductServiceImpl();
        FundService fundSvc = new FundServiceImpl();

        // 每列商品寫入 goods，並扣減庫存
        for (Order.Item it : order.getItems()) {
            Goods g = new Goods();
            g.setMemberId(memberId);
            g.setProductId(it.getProductId());
            g.setProductName(it.getProductName());
            g.setUnitPrice(it.getUnitPrice());
            g.setQuantity(it.getQuantity());
            g.setLineTotal(it.getLineTotal());
            g.setOrderTotal(total);
            g.setPaidCash(cash);
            g.setChangeAmount(change);
            goodsSvc.save(g);

            // 扣庫存
            prodSvc.changeStock(it.getProductId(), -it.getQuantity());
        }

        // 公司資金入帳 + 記錄交易
        fundSvc.addIncome(total);
        fundSvc.addTxn("SALE", total, "會員購買", null);

        int ask = JOptionPane.showConfirmDialog(this,
                "已完成購買，共 " + order.getItems().size() + " 項。\n\n" + ChangeTool.breakdown(change) +
                        "\n\n需要列印購物清單嗎？", "完成", JOptionPane.YES_NO_OPTION);
        if (ask == JOptionPane.YES_OPTION) {
            try {
                DateTimeFormatter F = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
                MessageFormat header = new MessageFormat("購物清單  " + LocalDateTime.now().format(F));
                MessageFormat footer = new MessageFormat(String.format("總額：$%d    付款：$%d    找零：$%d", total, cash, change));
                table.print(JTable.PrintMode.FIT_WIDTH, header, footer);
            } catch (PrinterException e) {
                JOptionPane.showMessageDialog(this, "列印失敗：" + e.getMessage());
            }
        }

        order.clear();
        if (onCompleted != null) onCompleted.run();
        dispose();
    }
}
