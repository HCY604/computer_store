package controller;

import model.Product;
import service.FundService;
import service.ProductService;
import service.impl.FundServiceImpl;
import service.impl.ProductServiceImpl;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.List;

public class ProcurementUi extends JFrame {
    private static final long serialVersionUID = 1L;

    private final Runnable onAfter;
    private JTable table;
    private JLabel lblBalance;
    private Timer autoRefresh;

    public ProcurementUi(Runnable onAfter) {
        this.onAfter = onAfter;

        setSize(860, 560);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);

        UiKit.attachClockToTitle(this, "採購進貨（含安全水位）");
        UiKit.createBackButton(this, e -> {
            if (onAfter != null) onAfter.run();
            if (autoRefresh != null) autoRefresh.stop();
            dispose();
        });

        lblBalance = new JLabel("公司資金餘額：$" + new FundServiceImpl().getBalance());
        lblBalance.setBounds(120, 10, 300, 24);
        add(lblBalance);

        String[] cols = {"ID", "類別", "商品", "售價", "庫存", "安全水位", "建議進貨", "進貨數量"};
        DefaultTableModel m = new DefaultTableModel(cols, 0) {
            @Override public boolean isCellEditable(int r, int c) {
                // 允許編輯「安全水位」與「進貨數量」
                return c == 5 || c == 7;
            }
        };
        table = new JTable(m);
        JScrollPane sp = new JScrollPane(table);
        sp.setBounds(20, 50, 810, 400);
        add(sp);

        // ✅ 正確的列渲染方式：覆寫 getTableCellRendererComponent 來取得 row/column
        DefaultTableCellRenderer lowRenderer = new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(
                    JTable tbl, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
                Component comp = super.getTableCellRendererComponent(tbl, value, isSelected, hasFocus, row, column);
                try {
                    int stock = Integer.parseInt(String.valueOf(tbl.getValueAt(row, 4)));
                    int safe  = Integer.parseInt(String.valueOf(tbl.getValueAt(row, 5)));
                    boolean low = stock < safe;

                    // 避免覆蓋選取前景色
                    if (!isSelected) {
                        comp.setForeground(low ? Color.RED : Color.BLACK);
                    } else {
                        comp.setForeground(tbl.getSelectionForeground());
                    }
                } catch (Exception ignore) {
                    if (!isSelected) comp.setForeground(Color.BLACK);
                }
                return comp;
            }
        };
        // 庫存與安全水位這兩欄用紅字提示
        table.getColumnModel().getColumn(4).setCellRenderer(lowRenderer);
        table.getColumnModel().getColumn(5).setCellRenderer(lowRenderer);

        JButton btnRecalc = new JButton("重新計算建議");
        btnRecalc.setBounds(20, 470, 130, 28);
        add(btnRecalc);

        JButton btnRun = new JButton("執行採購");
        btnRun.setBounds(700, 470, 130, 28);
        add(btnRun);

        btnRecalc.addActionListener(e -> recalcSuggestion(m));
        btnRun.addActionListener(e -> doProcure(m));

        loadProducts(m);
        recalcSuggestion(m);

        // 即時刷新餘額/庫存
        autoRefresh = new Timer(4000, e -> {
            lblBalance.setText("公司資金餘額：$" + new FundServiceImpl().getBalance());
            loadProducts(m);      // 另一視窗可能變動庫存
            recalcSuggestion(m);
        });
        autoRefresh.start();
    }

    private void loadProducts(DefaultTableModel m) {
        m.setRowCount(0);
        List<Product> list = new ProductServiceImpl().findAll();
        for (Product p : list) {
            int safe = 10; // 預設安全水位（可改由 DB 讀 safe_stock）
            m.addRow(new Object[]{
                    p.getId(), p.getCategory(), p.getName(), p.getPrice(),
                    p.getStock(), safe, 0, 0
            });
        }
    }

    private void recalcSuggestion(DefaultTableModel m) {
        for (int i = 0; i < m.getRowCount(); i++) {
            int stock = toInt(m.getValueAt(i, 4));
            int safe  = toInt(m.getValueAt(i, 5));
            int suggest = Math.max(0, safe - stock);
            m.setValueAt(suggest, i, 6);
            // 若尚未輸入進貨數量，預填建議值
            if (toInt(m.getValueAt(i, 7)) == 0) m.setValueAt(suggest, i, 7);
        }
    }

    private int toInt(Object o) {
        try { return Integer.parseInt(String.valueOf(o)); }
        catch (Exception e) { return 0; }
    }

    private void doProcure(DefaultTableModel m) {
        ProductService ps = new ProductServiceImpl();
        FundService fs   = new FundServiceImpl();

        int rows = m.getRowCount();
        int totalCost = 0;

        for (int i = 0; i < rows; i++) {
            int qty = toInt(m.getValueAt(i, 7));
            if (qty <= 0) continue;

            int id    = toInt(m.getValueAt(i, 0));
            int price = toInt(m.getValueAt(i, 3));
            int unitCost = (int) Math.round(price * 0.7); // 成本=70%
            int cost = unitCost * qty;
            totalCost += cost;

            // 增加庫存
            ps.changeStock(id, qty);
            // 記資金交易（支出）
            fs.addTxn("PROCURE", -cost, "採購入庫", id);
        }

        if (totalCost > 0) {
            fs.addExpense(totalCost); // 扣公司的錢
            JOptionPane.showMessageDialog(this, "採購完成，花費 $" + totalCost);
            lblBalance.setText("公司資金餘額：$" + fs.getBalance());
            loadProducts(m);
            recalcSuggestion(m);
            if (onAfter != null) onAfter.run();
        } else {
            JOptionPane.showMessageDialog(this, "未輸入任何進貨數量");
        }
    }
}
