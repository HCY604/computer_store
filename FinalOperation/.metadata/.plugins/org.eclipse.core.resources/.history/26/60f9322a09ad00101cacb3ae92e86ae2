package controller;

import model.Goods;
import model.Member;
import model.Product;
import service.FundService;
import service.GoodsService;
import service.ProductService;
import service.impl.FundServiceImpl;
import service.impl.GoodsServiceImpl;
import service.impl.ProductServiceImpl;
import util.ChangeTool;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.print.PrinterException;
import java.util.*;
import java.awt.*;

public class ConsumerShopUi extends JFrame {
    private static final long serialVersionUID = 1L;

    private final JFrame back;
    private final Member loginMember;
    private final ProductService productSvc = new ProductServiceImpl();
    private final GoodsService goodsSvc = new GoodsServiceImpl();
    private final FundService fundSvc = new FundServiceImpl();

    private JComboBox<String> cboCategory, cboProduct;
    private JTextField txtPrice;
    private JSpinner spQty;
    private JTable table;
    private DefaultTableModel model;
    private JLabel lblTotal, lblStock;
    private Map<String, List<Product>> byCat = new LinkedHashMap<>();

    public ConsumerShopUi(JFrame back, Member m){
        this.back=back;
        this.loginMember=m;

        setSize(900, 650);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "購買電腦（會員：" + m.getUsername() + "）");
        UiKit.createBackButton(this, e -> { back.setVisible(true); dispose(); });

        loadProducts();

        JLabel l1=new JLabel("類別"); l1.setBounds(20,50,50,24); add(l1);
        JLabel l2=new JLabel("商品"); l2.setBounds(220,50,50,24); add(l2);
        JLabel l3=new JLabel("單價"); l3.setBounds(520,50,50,24); add(l3);
        JLabel l4=new JLabel("數量"); l4.setBounds(640,50,50,24); add(l4);

        cboCategory=new JComboBox<>(byCat.keySet().toArray(new String[0]));
        cboCategory.setBounds(70,50,130,24); add(cboCategory);

        cboProduct=new JComboBox<>(); cboProduct.setBounds(270,50,230,24); add(cboProduct);
        txtPrice=new JTextField(); txtPrice.setBounds(560,50,70,24); txtPrice.setEditable(false); add(txtPrice);
        spQty=new JSpinner(new SpinnerNumberModel(1,1,99,1)); spQty.setBounds(690,50,60,24); add(spQty);

        lblStock=new JLabel("庫存：0"); lblStock.setBounds(760,50,100,24); add(lblStock);

        JButton btnAdd=new JButton("加入購物車"); btnAdd.setBounds(70,90,130,28); add(btnAdd);
        JButton btnDel=new JButton("刪除選取列"); btnDel.setBounds(220,90,130,28); add(btnDel);

        String[] cols={"類別","商品","單價","數量","小計"};
        model=new DefaultTableModel(cols,0){ @Override public boolean isCellEditable(int r,int c){ return false; } };
        table=new JTable(model);
        JScrollPane sp=new JScrollPane(table); sp.setBounds(20,130,840,380); add(sp);

        lblTotal=new JLabel("總金額：$0"); lblTotal.setBounds(20,520,200,28); lblTotal.setFont(lblTotal.getFont().deriveFont(16f)); add(lblTotal);
        JButton btnPay=new JButton("結帳 / 找零 / 列印"); btnPay.setBounds(700,520,160,30); add(btnPay);

        cboCategory.addActionListener(e -> refreshProducts());
        cboProduct.addActionListener(e -> syncPriceStock());
        btnAdd.addActionListener(e -> addItem());
        btnDel.addActionListener(e -> delRow());
        btnPay.addActionListener(e -> checkout());

        refreshProducts();
    }

    private void loadProducts(){
        for (Product p : productSvc.findAll()){
            byCat.computeIfAbsent(p.getCategory(), k -> new ArrayList<>()).add(p);
        }
    }

    private void refreshProducts(){
        cboProduct.removeAllItems();
        String cat = (String) cboCategory.getSelectedItem();
        if (cat!=null){
            for (Product p : byCat.getOrDefault(cat, Collections.emptyList())) {
                cboProduct.addItem(p.getName());
            }
        }
        syncPriceStock();
    }

    private void syncPriceStock(){
        String cat=(String)cboCategory.getSelectedItem();
        String name=(String)cboProduct.getSelectedItem();
        if (cat==null || name==null){ txtPrice.setText(""); lblStock.setText("庫存：0"); return; }
        for (Product p : byCat.getOrDefault(cat, Collections.emptyList())){
            if (p.getName().equals(name)){
                txtPrice.setText(String.valueOf(p.getPrice()));
                lblStock.setText("庫存：" + p.getStock());
                return;
            }
        }
    }

    private void addItem(){
        String cat=(String)cboCategory.getSelectedItem();
        String name=(String)cboProduct.getSelectedItem();
        int price=Integer.parseInt(txtPrice.getText());
        int qty=(int)spQty.getValue();

        // 檢查庫存
        Product sel=null;
        for (Product p : byCat.getOrDefault(cat, Collections.emptyList())){
            if (p.getName().equals(name)){ sel=p; break; }
        }
        if (sel==null) return;
        if (qty > sel.getStock()){ JOptionPane.showMessageDialog(this,"庫存不足（剩 "+sel.getStock()+"）"); return; }

        int line=price*qty;
        model.addRow(new Object[]{cat,name,price,qty,line});
        updateTotal();
    }

    private void delRow(){
        int r=table.getSelectedRow();
        if (r<0){ JOptionPane.showMessageDialog(this,"請選取要刪除的列"); return; }
        model.removeRow(r);
        updateTotal();
    }

    private void updateTotal(){
        int sum=0;
        for (int i=0;i<model.getRowCount();i++) sum += (int)model.getValueAt(i,4);
        lblTotal.setText("總金額：$"+sum);
    }

    private void checkout(){
        int total=0;
        for (int i=0;i<model.getRowCount();i++) total += (int)model.getValueAt(i,4);
        if (total<=0){ JOptionPane.showMessageDialog(this,"尚未加入商品"); return; }

        String s=JOptionPane.showInputDialog(this,"請輸入付款金額", String.valueOf(total));
        if (s==null) return;
        int cash;
        try { cash=Integer.parseInt(s.trim()); } catch (Exception ex){ JOptionPane.showMessageDialog(this,"金額格式錯誤"); return; }
        if (cash<total){ JOptionPane.showMessageDialog(this,"金額不足"); return; }
        int change=cash-total;

        // 寫入 DB：goods、多筆；扣庫存；資金入帳
        for (int i=0;i<model.getRowCount();i++){
            String cat=(String)model.getValueAt(i,0);
            String name=(String)model.getValueAt(i,1);
            int price=(int)model.getValueAt(i,2);
            int qty=(int)model.getValueAt(i,3);
            int line=(int)model.getValueAt(i,4);

            Goods g=new Goods();
            g.setMemberId(loginMember.getId());
            g.setCategoryName(cat);
            g.setProductName(name);
            g.setUnitPrice(price);
            g.setQuantity(qty);
            g.setLineTotal(line);
            g.setOrderTotal(total);
            g.setPaidCash(cash);
            g.setChangeAmount(change);
            goodsSvc.save(g);

            // 扣庫存
            Product sel=null;
            for (Product p : byCat.getOrDefault(cat, Collections.emptyList())) if (p.getName().equals(name)){ sel=p; break; }
            if (sel!=null){ new ProductServiceImpl().changeStock(sel.getId(), -qty); sel.setStock(sel.getStock()-qty); }
        }

        // 公司收入增加
        fundSvc.addTxn("SALE", total, "銷售收入", null);

        // 找零提示 + 列印 JTable
        JOptionPane.showMessageDialog(this, "付款完成！\n"+ ChangeTool.breakdown(change));
        try {
            boolean ok = table.print(JTable.PrintMode.FIT_WIDTH, new java.text.MessageFormat("購買清單（總額 $"+total+"）"),
                    new java.text.MessageFormat("列印時間：{0,date,yyyy-MM-dd HH:mm:ss}"));
            if (!ok) JOptionPane.showMessageDialog(this,"已取消列印");
        } catch (PrinterException e) {
            JOptionPane.showMessageDialog(this,"列印失敗：" + e.getMessage());
        }

        // 清空
        model.setRowCount(0);
        updateTotal();
        syncPriceStock();
    }
}
