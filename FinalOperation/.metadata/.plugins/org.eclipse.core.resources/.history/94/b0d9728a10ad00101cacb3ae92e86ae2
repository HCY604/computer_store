package dao.impl;

import dao.AttendanceDao;
import util.DbConnection;

import java.sql.*;

public class AttendanceDaoImpl implements AttendanceDao {
    @Override
    public int clockIn(String empCode, int ratePerSec) {
        String sql = "INSERT INTO attendance_log(employee_code, rate_per_sec) VALUES (?,?)";
        try (Connection c = DbConnection.getDb();
             PreparedStatement ps = c.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            ps.setString(1, empCode);
            ps.setInt(2, ratePerSec);
            ps.executeUpdate();
            try(ResultSet rs = ps.getGeneratedKeys()){
                if (rs.next()) return rs.getInt(1);
            }
        } catch (SQLException e) {
            throw new RuntimeException("上班打卡失敗：" + e.getMessage(), e);
        }
        return 0;
    }

    @Override
    public void clockOut(int logId) {
        String sql = "UPDATE attendance_log SET clock_out=NOW(), seconds_worked = TIMESTAMPDIFF(SECOND, clock_in, NOW()) WHERE id=? AND clock_out IS NULL";
        try (Connection c = DbConnection.getDb();
             PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setInt(1, logId);
            ps.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException("下班打卡失敗：" + e.getMessage(), e);
        }
    }

    @Override
    public int getOpenLogId(String empCode) {
        String sql = "SELECT id FROM attendance_log WHERE employee_code=? AND clock_out IS NULL ORDER BY id DESC LIMIT 1";
        try (Connection c = DbConnection.getDb();
             PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setString(1, empCode);
            try(ResultSet rs = ps.executeQuery()){
                if (rs.next()) return rs.getInt(1);
            }
        } catch (SQLException e) {
            throw new RuntimeException("查詢打卡狀態失敗：" + e.getMessage(), e);
        }
        return 0;
    }

    @Override
    public int sumUnpaidSeconds(String empCode) {
        String sql = "SELECT IFNULL(SUM(seconds_worked*rate_per_sec),0) FROM attendance_log WHERE employee_code=? AND salary_paid=0 AND clock_out IS NOT NULL";
        try (Connection c = DbConnection.getDb();
             PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setString(1, empCode);
            try(ResultSet rs = ps.executeQuery()){
                if (rs.next()) return rs.getInt(1);
            }
        } catch (SQLException e) {
            throw new RuntimeException("統計未發薪時數失敗：" + e.getMessage(), e);
        }
        return 0;
    }

    @Override
    public void markPaid(String empCode) {
        String sql = "UPDATE attendance_log SET salary_paid=1, paid_at=NOW() WHERE employee_code=? AND salary_paid=0 AND clock_out IS NOT NULL";
        try (Connection c = DbConnection.getDb();
             PreparedStatement ps = c.prepareStatement(sql)) {
            ps.setString(1, empCode);
            ps.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException("更新發薪狀態失敗：" + e.getMessage(), e);
        }
    }
}
