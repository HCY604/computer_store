package controller;

import model.Product;
import service.FundService;
import service.ProductService;
import service.impl.FundServiceImpl;
import service.impl.ProductServiceImpl;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.util.List;

public class AdminProcurementWindow extends JFrame {
    private static final long serialVersionUID = 1L;
    private final JFrame back;
    private final ProductService psvc = new ProductServiceImpl();
    private final FundService fsvc = new FundServiceImpl();

    private JTable table;
    private DefaultTableModel model;
    private JSpinner sp;

    public AdminProcurementWindow(JFrame back){
        this.back=back;
        setSize(820,600); setLocationRelativeTo(null); setLayout(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        UiKit.attachClockToTitle(this,"採購 / 補貨（成本=售價 x 60%）");
        UiKit.createBackButton(this, e->{ back.setVisible(true); dispose(); });

        String[] cols={"ID","類別","商品","售價","庫存","安全水位"};
        model=new DefaultTableModel(cols,0){ @Override public boolean isCellEditable(int r,int c){ return false; }};
        table=new JTable(model);
        JScrollPane spane=new JScrollPane(table); spane.setBounds(20,60,760,420); add(spane);

        JLabel l=new JLabel("數量"); l.setBounds(20,500,40,26); add(l);
        sp=new JSpinner(new SpinnerNumberModel(1,1,999,1)); sp.setBounds(60,500,70,26); add(sp);
        JButton add=new JButton("+"); add.setBounds(140,500,50,26); add(add);
        JButton sub=new JButton("-"); sub.setBounds(200,500,50,26); add(sub);
        JButton buy=new JButton("進貨"); buy.setBounds(680,500,100,30); add(buy);

        add.addActionListener(e-> sp.setValue((int)sp.getValue()+1));
        sub.addActionListener(e-> { int v=(int)sp.getValue(); if(v>1) sp.setValue(v-1); });

        buy.addActionListener(e->doBuy());

        reload();
    }

    private void reload(){
        model.setRowCount(0);
        List<Product> list = psvc.findAll();
        for (Product p: list) model.addRow(new Object[]{p.getId(),p.getCategory(),p.getName(),p.getPrice(),p.getStock(),p.getSafeStock()});
    }

    private void doBuy(){
        int r=table.getSelectedRow(); if(r<0){ JOptionPane.showMessageDialog(this,"請選取商品"); return; }
        int id=(int)model.getValueAt(r,0);
        int price=(int)model.getValueAt(r,3);
        int qty=(int)sp.getValue();
        int cost = (int)Math.round(price * 0.6) * qty;  // 60% 成本

        // 扣公司資金（支出要用負數）
        fsvc.addTxn("PROCURE", -cost, "採購："+model.getValueAt(r,2)+" x"+qty, id);
        // 加庫存
        psvc.changeStock(id, qty);
        JOptionPane.showMessageDialog(this,"進貨成功，成本："+cost);
        reload();
    }
}
