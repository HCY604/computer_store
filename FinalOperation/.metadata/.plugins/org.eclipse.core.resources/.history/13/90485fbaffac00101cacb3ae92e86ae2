package controller;

import model.Product;
import service.FundService;
import service.ProductService;
import service.impl.FundServiceImpl;
import service.impl.ProductServiceImpl;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.util.List;

public class ProcurementUi extends JFrame {
    private static final long serialVersionUID = 1L;

    private final Runnable onAfter;
    private JTable table;
    private JLabel lblBalance;
    private Timer autoRefresh;

    public ProcurementUi(Runnable onAfter) {
        this.onAfter = onAfter;
        setSize(860, 560);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "採購進貨（含安全水位）");
        UiKit.createBackButton(this, e -> { if (onAfter!=null) onAfter.run(); if (autoRefresh!=null) autoRefresh.stop(); dispose(); });

        lblBalance = new JLabel("公司資金餘額：$" + new FundServiceImpl().getBalance());
        lblBalance.setBounds(120, 10, 300, 24); add(lblBalance);

        String[] cols={"ID","類別","商品","售價","庫存","安全水位","建議進貨","進貨數量"};
        DefaultTableModel m = new DefaultTableModel(cols,0){
            public boolean isCellEditable(int r,int c){ return c==5 || c==7; }
        };
        table = new JTable(m);
        JScrollPane sp = new JScrollPane(table); sp.setBounds(20,50,810,400); add(sp);

        // 紅字顯示低於安全水位
        DefaultTableCellRenderer redIfLow = new DefaultTableCellRenderer() {
            @Override protected void setValue(Object value) {
                super.setValue(value);
                int row = table.getEditingRow()>=0 ? table.getEditingRow() : table.getSelectionModel().getLeadSelectionIndex();
                try {
                    int stock = Integer.parseInt(String.valueOf(table.getValueAt(getRow(), 4)));
                    int safe  = Integer.parseInt(String.valueOf(table.getValueAt(getRow(), 5)));
                    setForeground(stock < safe ? Color.RED : Color.BLACK);
                } catch (Exception ignore) {
                    setForeground(Color.BLACK);
                }
            }
        };
        table.getColumnModel().getColumn(4).setCellRenderer(redIfLow);
        table.getColumnModel().getColumn(5).setCellRenderer(redIfLow);

        JButton btnRecalc = new JButton("重新計算建議");
        btnRecalc.setBounds(20, 470, 130, 28); add(btnRecalc);
        JButton btnRun = new JButton("執行採購");
        btnRun.setBounds(700,470,130,28); add(btnRun);

        btnRecalc.addActionListener(e -> recalcSuggestion(m));
        btnRun.addActionListener(e -> doProcure(m));

        loadProducts(m);
        recalcSuggestion(m);

        // 即時刷新餘額/庫存
        autoRefresh = new Timer(4000, e -> {
            lblBalance.setText("公司資金餘額：$" + new FundServiceImpl().getBalance());
            loadProducts(m);      // 另一窗口也可能變動庫存
            recalcSuggestion(m);
        });
        autoRefresh.start();
    }

    private void loadProducts(DefaultTableModel m){
        m.setRowCount(0);
        List<Product> list = new ProductServiceImpl().findAll();
        for (Product p : list) {
            int safe = 10; // 預設安全水位，可自行調整或改成從 DB 讀
            m.addRow(new Object[]{p.getId(), p.getCategory(), p.getName(), p.getPrice(), p.getStock(), safe, 0, 0});
        }
    }

    private void recalcSuggestion(DefaultTableModel m){
        for (int i=0;i<m.getRowCount();i++){
            int stock = toInt(m.getValueAt(i,4));
            int safe  = toInt(m.getValueAt(i,5));
            int suggest = Math.max(0, safe - stock);
            m.setValueAt(suggest, i, 6);
            if (toInt(m.getValueAt(i,7))==0) m.setValueAt(suggest, i, 7); // 預填進貨數量
        }
    }

    private int toInt(Object o){ try { return Integer.parseInt(String.valueOf(o)); } catch (Exception e){ return 0; } }

    private void doProcure(DefaultTableModel m) {
        ProductService ps = new ProductServiceImpl();
        FundService fs = new FundServiceImpl();
        int rows = m.getRowCount();
        int totalCost = 0;
        for (int i=0;i<rows;i++){
            int qty = toInt(m.getValueAt(i,7));
            if (qty<=0) continue;
            int id    = toInt(m.getValueAt(i,0));
            int price = toInt(m.getValueAt(i,3));
            int unitCost = (int)Math.round(price * 0.7); // 成本=70%
            int cost = unitCost * qty;
            totalCost += cost;

            // 增加庫存
            ps.changeStock(id, qty);
            // 記交易
            fs.addTxn("PROCURE", -cost, "採購入庫", id);
        }
        if (totalCost>0){
            fs.addExpense(totalCost); // 扣公司的錢
            JOptionPane.showMessageDialog(this,"採購完成，花費$"+totalCost);
            lblBalance.setText("公司資金餘額：$" + fs.getBalance());
            loadProducts(m);
            recalcSuggestion(m);
            if (onAfter!=null) onAfter.run();
        } else {
            JOptionPane.showMessageDialog(this,"未輸入任何進貨數量");
        }
    }
}
