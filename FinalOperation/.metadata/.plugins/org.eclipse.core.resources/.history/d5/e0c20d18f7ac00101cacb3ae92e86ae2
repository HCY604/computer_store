package controller;

import model.Goods;
import model.Member;
import service.GoodsService;
import service.impl.GoodsServiceImpl;
import util.ChangeTool;
import util.Tool;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.print.PrinterException;
import java.text.MessageFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

public class CheckoutReview extends JFrame {
    private static final long serialVersionUID = 1L;

    private final Order order;            // 與購物頁共享
    private final Runnable onCompleted;   // 購買完成後回呼（讓購物頁清空並刷新）
    private JTable table;
    private JLabel lblTotal;

    public CheckoutReview(Order order, Runnable onCompleted) {
        this.order = order;
        this.onCompleted = onCompleted;

        setSize(720, 520);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLayout(null);
        UiKit.attachClockToTitle(this, "結帳確認");
        UiKit.createBackButton(this, e -> { dispose(); }); // 回到購物頁

        String[] cols = {"類別","產品名稱","單價","數量","小計"};
        DefaultTableModel m = new DefaultTableModel(cols, 0) {
            public boolean isCellEditable(int r, int c){ return false; }
        };
        table = new JTable(m);
        JScrollPane sp = new JScrollPane(table);
        sp.setBounds(20, 50, 660, 360); add(sp);

        JButton btnDelete = new JButton("刪除選取");
        btnDelete.setBounds(20, 420, 110, 28); add(btnDelete);

        lblTotal = new JLabel("應付總額：$" + order.getTotalAmount());
        lblTotal.setBounds(150, 420, 220, 28); add(lblTotal);

        JButton btnConfirm = new JButton("確認購買並列印");
        btnConfirm.setBounds(520, 420, 160, 28); add(btnConfirm);

        btnDelete.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row < 0) { JOptionPane.showMessageDialog(this, "先選一列"); return; }
            order.removeItemAt(row);
            m.removeRow(row);
            refreshTotal();
        });
        btnConfirm.addActionListener(e -> doPurchaseAndPrint());

        reloadTable(m);
    }

    private void reloadTable(DefaultTableModel m) {
        m.setRowCount(0);
        for (Order.Item it : order.getItems()) {
            m.addRow(new Object[]{ it.getCategoryName(), it.getProductName(), it.getUnitPrice(), it.getQuantity(), it.getLineTotal() });
        }
        refreshTotal();
    }

    private void refreshTotal() {
        lblTotal.setText("應付總額：$" + order.getTotalAmount());
    }

    private void doPurchaseAndPrint() {
        int total = order.getTotalAmount();
        if (total <= 0) { JOptionPane.showMessageDialog(this, "購物車已空"); return; }

        String s = JOptionPane.showInputDialog(this, "請輸入付款金額（整數）", String.valueOf(total));
        if (s == null) return;
        int cash;
        try { cash = Integer.parseInt(s.trim()); }
        catch (Exception ex) { JOptionPane.showMessageDialog(this, "金額格式不正確"); return; }
        if (cash < total) { JOptionPane.showMessageDialog(this, "付款金額不足（應付 $" + total + "）"); return; }
        int change = cash - total;

        Integer memberId = null;
        try { Member m = Tool.loadMember(); if (m != null) memberId = m.getId(); } catch (Exception ignore){}

        GoodsService svc = new GoodsServiceImpl();
        for (Order.Item it : order.getItems()) {
            Goods g = new Goods();
            g.setMemberId(memberId);
            g.setCategoryName(it.getCategoryName());
            g.setProductName(it.getProductName());
            g.setUnitPrice(it.getUnitPrice());
            g.setQuantity(it.getQuantity());
            g.setLineTotal(it.getLineTotal());
            g.setOrderTotal(total);
            g.setPaidCash(cash);
            g.setChangeAmount(change);
            svc.save(g); // 內部可處理庫存扣減與紀錄
        }

        int ask = JOptionPane.showConfirmDialog(this,
                "已完成購買，共 " + order.getItems().size() + " 項。\n\n" + ChangeTool.breakdown(change) +
                        "\n\n需要列印購物清單嗎？", "完成", JOptionPane.YES_NO_OPTION);
        if (ask == JOptionPane.YES_OPTION) {
            try {
                // 頁眉：現在時間；頁腳：總額/付款/找零
                DateTimeFormatter F = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
                MessageFormat header = new MessageFormat("購物清單  " + LocalDateTime.now().format(F));
                MessageFormat footer = new MessageFormat(
                        String.format("總額：$%d    付款：$%d    找零：$%d", total, cash, change)
                );
                table.print(JTable.PrintMode.FIT_WIDTH, header, footer);
            } catch (PrinterException e) {
                JOptionPane.showMessageDialog(this, "列印失敗：" + e.getMessage());
            }
        }

        order.clear();
        if (onCompleted != null) onCompleted.run();
        dispose();
    }
}
