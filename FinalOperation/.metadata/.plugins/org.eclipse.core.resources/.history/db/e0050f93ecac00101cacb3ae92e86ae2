package dao.impl;

import dao.FundDao;
import util.DbConnection;

import java.sql.*;

public class FundDaoImpl implements FundDao {

    @Override
    public int getBalance() {
        String sql = "SELECT balance FROM company_fund WHERE id=1";
        try (PreparedStatement ps = DbConnection.getDb().prepareStatement(sql);
             ResultSet rs = ps.executeQuery()) {
            if (rs.next()) return rs.getInt(1);
        } catch (SQLException e) { e.printStackTrace(); }
        return 0;
    }

    @Override
    public boolean addTxn(String type, int amount, String note, Long relatedId) {
        String ins = "INSERT INTO company_fund_txn(txn_type,amount,note,related_id) VALUES(?,?,?,?)";
        String upd = "UPDATE company_fund SET balance = balance + ? WHERE id=1";
        try (Connection conn = DbConnection.getDb()) {
            conn.setAutoCommit(false);
            try (PreparedStatement ps = conn.prepareStatement(ins)) {
                ps.setString(1, type);
                ps.setInt(2, amount);
                ps.setString(3, note);
                if (relatedId == null) ps.setNull(4, Types.BIGINT); else ps.setLong(4, relatedId);
                ps.executeUpdate();
            }
            try (PreparedStatement ps = conn.prepareStatement(upd)) {
                ps.setInt(1, amount);
                ps.executeUpdate();
            }
            conn.commit();
            return true;
        } catch (SQLException e) { e.printStackTrace(); }
        return false;
    }
}
