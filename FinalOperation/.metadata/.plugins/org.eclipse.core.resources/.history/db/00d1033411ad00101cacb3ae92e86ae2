package controller;

import model.Employee;
import service.AttendanceService;
import service.EmployeeService;
import service.FundService;
import service.impl.AttendanceServiceImpl;
import service.impl.EmployeeServiceImpl;
import service.impl.FundServiceImpl;
import util.UiKit;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;

public class PayrollUi extends JFrame {
    private static final long serialVersionUID = 1L;
    private final JFrame back;
    private final EmployeeService empSvc = new EmployeeServiceImpl();
    private final AttendanceService attSvc = new AttendanceServiceImpl();
    private final FundService fundSvc = new FundServiceImpl();

    private JTable table; private DefaultTableModel model; private JLabel lblBalance;

    public PayrollUi(JFrame back){
        this.back=back;
        setSize(680, 420); setLocationRelativeTo(null); setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE); setLayout(null);
        UiKit.attachClockToTitle(this,"發薪（人事成本）"); UiKit.createBackButton(this, e -> { back.setVisible(true); dispose(); });

        lblBalance=new JLabel("公司資金餘額：$"+fundSvc.getBalance()); lblBalance.setBounds(120,10,300,24); add(lblBalance);

        String[] cols={"代碼","姓名","待發金額"}; model=new DefaultTableModel(cols,0){ @Override public boolean isCellEditable(int r,int c){ return false; } };
        table=new JTable(model); JScrollPane sp=new JScrollPane(table); sp.setBounds(20,50,620,260); add(sp);

        JButton btnPay=new JButton("發薪給選取員工"); btnPay.setBounds(20,320,160,28); add(btnPay);
        JButton btnRefresh=new JButton("重新整理"); btnRefresh.setBounds(200,320,120,28); add(btnRefresh);

        btnPay.addActionListener(e -> paySelected());
        btnRefresh.addActionListener(e -> reload());

        reload();
    }

    private void reload(){
        model.setRowCount(0);
        for (Employee e : empSvc.list()){
            int due = attSvc.unpaidAmount(e.getEmpCode());
            model.addRow(new Object[]{e.getEmpCode(), e.getEmpName(), due});
        }
        lblBalance.setText("公司資金餘額：$"+fundSvc.getBalance());
    }

    private void paySelected(){
        int r=table.getSelectedRow(); if (r<0){ JOptionPane.showMessageDialog(this,"請選取員工"); return; }
        String code=(String)model.getValueAt(r,0);
        int due=(int)model.getValueAt(r,2);
        if (due<=0){ JOptionPane.showMessageDialog(this,"此員工無待發薪資"); return; }
        try{
            // 記資金交易（PAYROLL，支出）
            fundSvc.addTxn("PAYROLL", -due, "發薪給 "+code, null);
            // 標記出勤紀錄為已發薪
            attSvc.markPaid(code);
            JOptionPane.showMessageDialog(this,"已發薪 $"+due+" 給 "+code);
            reload();
        }catch(Exception ex){ JOptionPane.showMessageDialog(this, ex.getMessage()); }
    }
}
