package controller;

import model.AdminUser;
import service.AdminService;
import service.ReportService;
import service.impl.AdminServiceImpl;
import service.impl.ReportServiceImpl;
import vo.DailyProfitVo;

import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartPanel;
import org.jfree.chart.JFreeChart;
import org.jfree.data.category.DefaultCategoryDataset;

import javax.swing.*;
import java.awt.*;
import java.util.List;

public class AdminPanel extends JFrame {
    private static final long serialVersionUID = 1L;

    private final AdminUser admin;
    private final AdminService adminSvc = new AdminServiceImpl();
    private final ReportService reportSvc = new ReportServiceImpl();

    private JLabel lblBalance;
    private JPanel chartPanel;

    public AdminPanel(AdminUser a) {
        this.admin = a;
        setTitle("管理員面板 - " + a.getUsername());
        setSize(980, 720);
        setLocationRelativeTo(null);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLayout(null);

        lblBalance = new JLabel("資金餘額：" + admin.getBalance());
        lblBalance.setBounds(20, 20, 300, 24); add(lblBalance);

        JButton btnProcure   = new JButton("採購進貨");     btnProcure.setBounds(20, 60, 120, 28); add(btnProcure);
        JButton btnRefresh   = new JButton("刷新圖表");     btnRefresh.setBounds(150, 60, 120, 28); add(btnRefresh);
        JButton btnBack      = new JButton("登出");         btnBack.setBounds(280, 60, 120, 28); add(btnBack);

        chartPanel = new JPanel(new BorderLayout());
        chartPanel.setBounds(20, 110, 930, 560);
        chartPanel.setBorder(BorderFactory.createTitledBorder("營收 / 進貨 / 毛利（最近 30 天）"));
        add(chartPanel);

        btnProcure.addActionListener(e -> new ProcurementUi(admin, this::refreshBalance).setVisible(true));
        btnRefresh.addActionListener(e -> drawChart());
        btnBack.addActionListener(e -> { new RoleSelector().setVisible(true); dispose(); });

        drawChart();
    }

    private void refreshBalance() {
        int bal = adminSvc.getBalance(admin.getId());
        admin.setBalance(bal);
        lblBalance.setText("資金餘額：" + bal);
    }

    private void drawChart() {
        List<DailyProfitVo> data = reportSvc.listDailyProfit(30);
        DefaultCategoryDataset ds = new DefaultCategoryDataset();
        for (DailyProfitVo v : data) {
            ds.addValue(v.getSalesAmount(), "營收", v.getBizDate());
            ds.addValue(v.getProcureCost(), "進貨成本", v.getBizDate());
            ds.addValue(v.getGrossProfit(), "毛利", v.getBizDate());
        }
        JFreeChart chart = ChartFactory.createLineChart(
                "每日營收/進貨/毛利", "日期", "金額", ds);
        ChartPanel cp = new ChartPanel(chart);
        chartPanel.removeAll();
        chartPanel.add(cp, BorderLayout.CENTER);
        chartPanel.revalidate();
        chartPanel.repaint();
    }
}
